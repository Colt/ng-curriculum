## Dependency Injection And Services

**Dependency injection** is core feature to angular that helps us make more modular code.

Dependency injection is a software pattern that angular uses to figure out what dependencies (e.g. $scope, $http service, etc) a software component (e.g. a controller, a module, etc) has.  For example, the following controller depends on $scope and $routeParams:

```
app.controller('MathController', function($scope, $routeParams){
  $scope.val1 = parseInt($routeParams.val1, 10);
  $scope.val2 = parseInt($routeParams.val2, 10);
  $scope.op = "";
  $scope.result = 0;
  if ($routeParams.op === "add") {
    $scope.op = "+";
    $scope.result = $scope.val1 + $scope.val2;
  } else if ($routeParams.op === "subtract") {
    $scope.op = "-";
    $scope.result = $scope.val1 - $scope.val2;
  }
});
```

**EXERCISE: Look at an angular app you have made previous (reddit clone or your portfolio site).  What dependencies are there?  Where do you see dependencies other than the contoller?**

**EXERCISE:  In the above example (MathController) does the order of the dependencies matter?  Does $scope have to come before $routeParams?  Do the names matter?  Could we name them something else?**

**EXERCISE: DO NOT SKIP THIS EXERCISE.  In production code, you typically want your javascript file to be as small as possible so that it can be downloaded faster.  To make the files smaller, developers minify their js files.  Find a minification tool and minify your js code.  Update your html file so that it now points to your newly minified js files.  Does your angular app still work?  If it stopped working, what is the problem?**

**EXERCISE: So far we have mainly seen one way to do dependency injection.  Research and figure out the other two ways.  Which one is the best practice?**

![](http://html5hub.com/wp-content/uploads/2013/11/superA.png)

Angular supports 3 ways to define dependencies for your code:

1.  Implicit annotation
2.  Inline array annotation
3.  $inject property annotation

We have been usiing __implicit annotation__ so far.  Implicit annotation is kind of a hack because angular actually has to parse your code and convert the parameters of your function to a string in order to figure out your dependencies.  __The implicit annotation dependency injection will break when you minify your code.__   This happens because minfication tools rename variables to a something smaller, but the minification tool doesn't know that the variable name in the function is meaningful to angular.

__BEST PRACTICE__: Always use inline array annotation.

**EXERCISE: Fix the app you minified earlier to use inline array annotation.  Minify the javascript files again.  Verify that the code still works when using the minified js.**

**EXERCISE: When using inline array annotation does the order of anything matter?  What order should match?**

**EXERCISE: Read over the [angular docs on dependency injection](https://docs.angularjs.org/guide/di).  Try to understand as much as you can.**


## Services

Angular services are components that are added to your code via dependency injection.  From the angular docs:

```
Angular services are:

* Lazily instantiated – Angular only instantiates a service when an application component depends on it.
* Singletons – Each component dependent on a service gets a reference to the single instance generated by the service factory.
```

**EXERCISE: Name at least 3 angular built in services that we have used so far.**


Now that we are more comfortable using services and injecting a service as dependency, let's create our own.  In your contact app, add the following code to `service.js`:

```
app.factory('contacts', function() {
  var contacts = {};

  contacts.contactList = [];

  contacts.addContact = function(name, email, phone) {
    contactList.data.push(name: name, email: email, phone: phone);
  };

  contacts.findContact = function(name) {
    // TODO
  };

  contact.removeContact = function(index) {
    // TODO
  };
  
  return contacts;
});
```

Now in your controller you can add the contact service you created as a dependency.  For example, your controller might look like this:

```
app.controller('ContactController', ["$scope", "contacts", function($scope, contacts){
   $scope.contactData = contacts.contactList;
   
   // TODO: Your contacts controller code here.
}]);
```

**EXERCISE: Refactor your contacts app to use a contacts service.  Remember to stick with best practices and use the inline array annotation.**

**EXERCISE: Add a show page to your contacts app. This will require a separate controller but you can use the same contacts service and share it between controllers. The "id" for the show page should by the index of contact in the contactList.**

#### Deferreds and Promises

In jQuery you saw promises often.  The most common use case was an ajax call.  For example, you might have some code like this in jQuery:

```
$.get("/puppies").done(function() { // do something here})
                 .fail(function() { // do something here});
```

The object returned from the `$.get` method is a promise that can then be chained to other method calls when certain events take place.  You can think of a promise as a more generalized way of implementing a callback.

Another popular library for promises is [q](https://github.com/kriskowal/q)

**EXERCISE: Read the docs for [the q promise library](https://github.com/kriskowal/q).  Why would you prefer to use a promise over a callback?  What advantage does it have?**

#### Creating a Service With Dependencies

Your service could also have dependencies.  We have seen the `$http` service.  In the example we will also used the `$q` service to add deferreds to our service:

```
app.factory('omdbapi', ["$http", "$q", function($http, $q) {
  var omdbservice = {};
  var baseUrl = http://www.omdbapi.com/?plot=short&r=json&s=";
  var searchTerm = '';


  omdbservice.setSearchTerm = function(term) {
    searchTerm = encodeURIComponent(term);
  }
  
  omdbservice.getSearchTerm = function() {
    return decodeURIComponent(searchTerm);
  }
  
  omdbservice.search(term) {
    if (term !== undefined) {
      omdbservice.setSearchTerm(term);
    }
    
    var url = baseUrl + searchTerm;
    
    var deferred = $q.defer();
    
    $http.get(url).success(function(data) {
      deferred.resolve(data);
    }).error(function() {
      deferred.reject("Error!")
    });
    
    return deferred.promise;
  }
  
  return omdbservice;
}]);
```

**EXERCISE: Use the [Giphy Api](https://github.com/Giphy/GiphyAPI) to add a feature to your app.  Whenever a new user is submitted, do a search for a gif using the person's name.  If you get a result, save that along with the users name email and phone number.  Show the user's gif on the show page.  HINT: you probably want to use the embedded url froom the giphy search resutls.**
